machine:
  environment:
    NODE_ENV: ci
    PORT: 3000
    RDS_HOSTNAME: 127.0.0.1
    RDS_DB_NAME: circle_test
    RDS_USERNAME: ubuntu
    RDS_PASSWORD: 
    AWS_DEFAULT_REGION: eu-west-1
    AWS_REGION: eu-west-1
    NOTIFICATIONS_SNS_TOPIC_ARN: arn:aws:sns:eu-west-1:168720412882:notifications-ci
    NOTIFICATIONS_EMAIL_SQS_QUEUE_URL: https://sqs.eu-west-1.amazonaws.com/168720412882/notifications-ci-email
    NOTIFICATIONS_SMS_SQS_QUEUE_URL: https://sqs.eu-west-1.amazonaws.com/168720412882/notifications-ci-sms		     
    MANDRILL_API_KEY: 1234567890
    TWILIO_ACCOUNT_SID: 1234567890
    TWILIO_AUTH_TOKEN: 1234567890
    TWILIO_PHONE_NUMBER: 1234567890
  services:
    - mysql

dependencies:
  pre:
    # Install Yarn
    - sudo apt-key adv --fetch-keys http://dl.yarnpkg.com/debian/pubkey.gpg
    - echo "deb http://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
    - sudo apt-get update -qq
    - sudo apt-get install -y -qq yarn=0.17.8-1
  override:
    - cd apartments-api && yarn install
    - cd front-gateway && yarn install
    - cd notifications-service && yarn install
  cache_directories:
    - ~/.yarn-cache
    - "apartments-api/node_modules"
    - "front-gateway/node_modules"
    - "notifications-service/node_modules"

test:
  override:
    - cd apartments-api && yarn run lint 
    - cd front-gateway && yarn run lint
    - cd notifications-service && yarn run lint
    - cd apartments-api && yarn run db:migrate
    - cd apartments-api && yarn run db:seed
    - cd apartments-api && yarn test
    - cd apartments-api && yarn run test:integration
    - cd front-gateway && yarn test 
    - cd front-gateway && yarn run test:e2e 
    - cd notifications-service && yarn test 
    - cd notifications-service && yarn run test:integration

deployment:
  staging:
    branch: develop
    commands:  
      - sudo apt-get update
      - sudo apt-get install python2.7-dev
      - sudo pip install awsebcli
      - yarn run deploy apartments-api stage
      - yarn run deploy front-gateway stage
      - yarn run deploy notifications-service stage    
