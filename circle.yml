machine:
  environment:
    NODE_ENV: ci
    PORT: 3000
    RDS_HOSTNAME: 127.0.0.1
    RDS_DB_NAME: circle_test
    RDS_USERNAME: ubuntu
    RDS_PASSWORD: 
    AWS_DEFAULT_REGION: eu-west-1
    AWS_REGION: eu-west-1
    NOTIFICATIONS_SNS_TOPIC_ARN: arn:aws:sns:eu-west-1:168720412882:notifications-ci
    NOTIFICATIONS_EMAIL_SQS_QUEUE_URL: https://sqs.eu-west-1.amazonaws.com/168720412882/notifications-ci-email
    NOTIFICATIONS_SMS_SQS_QUEUE_URL: https://sqs.eu-west-1.amazonaws.com/168720412882/notifications-ci-sms		     
    MANDRILL_API_KEY: 1234567890
    TWILIO_ACCOUNT_SID: 1234567890
    TWILIO_AUTH_TOKEN: 1234567890
    TWILIO_PHONE_NUMBER: 1234567890
  services:
    - mysql

dependencies:
  override:
    - npm --prefix ./apartments-api install --silent --production
    - npm --prefix ./apartments-api install --silent --production
    - npm --prefix ./notifications-service install --silent --production
  cache_directories:
    - "apartments-api/node_modules"
    - "front-gateway/node_modules"
    - "notifications-service/node_modules"

test:
  override:
    - npm --prefix ./apartments-api run lint 
    - npm --prefix ./front-gateway run lint
    - npm --prefix ./notifications-service run lint
    - npm --prefix ./apartments-api run db:migrate
    - npm --prefix ./apartments-api run db:seed
    - npm --prefix ./apartments-api test
    - npm --prefix ./apartments-api run test:integration
    - npm --prefix ./front-gateway test 
    - npm --prefix ./front-gateway run test:e2e 
    - npm --prefix ./notifications-service test 
    - npm --prefix ./notifications-service run test:integration

deployment:
  staging:
    branch: develop
    commands:  
      - sudo apt-get install python2.7-dev
      - sudo pip install awsebcli
      - npm run deploy apartments-api stage
      - npm run deploy front-gateway stage
      - npm run deploy notifications-service stage    
