version: '1.0'
steps:
  build-the-image:
    type: build
    description: Builds apartments-api
    working-directory: ${{initial-clone}}/apartments-api
    image-name: dorbel/apartments-api
    tag: develop
  unit-test:
    image: ${{build-the-image}}
    commands:
        - npm test
  integration-test:
      type: composition
      composition:
        version: '2'
        services:
          db:
            image: mysql:latest
            ports:
              - 3306
            environment:
              MYSQL_ROOT_PASSWORD: root
              MYSQL_DATABASE: dorbel
              MYSQL_USER: dorbel
              MYSQL_PASSWORD: dorbel
      composition-candidates:
        test:
          image: ${{build-the-image}}
          command: bash -c 'sleep 30 && RDS_HOSTNAME=db RDS_DB_NAME=dorbel RDS_USERNAME=dorbel RDS_PASSWORD=dorbel npm run test:integration'
  elastic-beanstalk:
    image: garland/aws-cli-docker:latest
    commands:>-
      sh -c  "[ ${{CF_BRANCH}} == feature/codefresh ] &&
      aws configure set aws_access_key_id ${{ACCESS_KEY_ID}} &&
      aws configure set aws_secret_access_key ${{SECRET_ACCESS_KEY_ID}} &&
      aws configure set region ${{REGION}} &&
      aws elasticbeanstalk update-environment --environment-name apartments-api-develop --version-label v0.1.${{CF_SHORT_REVISION}}"
