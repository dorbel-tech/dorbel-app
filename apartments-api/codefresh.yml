version: '1.0'

steps:
  build-the-image:
    type: build
    description: Builds apartments-api
    working-directory: ${{initial-clone}}/apartments-api
    image-name: dorbel/apartments-api
    tag: develop
  unit-test:
    image: ${{build-the-image}}
    commands:
      - npm run lint
      - npm run test
  integration-test:
      type: composition
      composition:
        version: '2'
        services:
          db:
            image: mysql:latest
            ports:
              - 3306
            environment:
              MYSQL_ROOT_PASSWORD: root
              MYSQL_DATABASE: dorbel
              MYSQL_USER: dorbel
              MYSQL_PASSWORD: dorbel
      composition-candidates:
        test:
          image: ${{build-the-image}}
          command: bash -c 'sleep 30 && export RDS_HOSTNAME=db;NODE_ENV=test && npm run db:migrate && npm run db:seed && npm run test:integration'
  # deployment:      
  #   image: ${{build-the-image}}
  #   commands: 
  #     - >-
  #       sh -c "
  #       apt-get update &&
  #       apt-get -y install python-pip python-dev build-essential && 
  #       pip install --upgrade pip &&
  #       pip install awsebcli &&
  #       export PATH=/usr/local/bin:$PATH
  #       eb deploy apartments-api-develop v0.1.test --message test 
  #       "
